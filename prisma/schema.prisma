// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum RoleScope {
  GLOBAL
  CENTER
}

enum ProfileType {
  TEACHER
  STUDENT
  GUARDIAN
  BASE_USER
}

enum StudentGrade {
  PRIMARY_1
  PRIMARY_2
  PRIMARY_3
  PRIMARY_4
  PRIMARY_5
  PRIMARY_6
  SECONDARY_1
  SECONDARY_2
  SECONDARY_3
  SECONDARY_4
  SECONDARY_5
  OTHER
}

model User {
  id                  String               @id @default(uuid())
  email               String               @unique
  password            String
  name                String
  isActive            Boolean              @default(true)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  centers             UserOnCenter[]
  refreshTokens       RefreshToken[]
  centersOwned        Center[]             @relation("UserCentersOwned")
  emailVerifications  EmailVerification[]
  passwordResetTokens PasswordResetToken[]
  failedLoginAttempts Int                  @default(0)
  lockoutUntil        DateTime?
  twoFactorSecret     String?
  twoFactorEnabled    Boolean              @default(false)
  userPermissions     UserPermission[]
  userRoles           UserRole[]
  // Profile relation (one-to-one)
  profile             Profile?
  // Add relations for UserAccess
  accessGranted       UserAccess[] @relation("AccessGranter")
  accessReceived      UserAccess[] @relation("AccessTarget")
}

// Polymorphic Profile table that references specific profile types
model Profile {
  id                  String       @id @default(uuid())
  userId              String       @unique
  type                ProfileType  @default(BASE_USER)
  
  // Common profile fields
  phone               String?
  address             String?
  dateOfBirth         DateTime?
  gender              String?
  avatar              String?
  
  // Polymorphic relations - only one will be set based on type
  teacherId           String?      @unique
  studentId           String?      @unique
  guardianId          String?      @unique
  baseUserId          String?      @unique
  
  // Metadata
  metadata            Json?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  user                User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  teacher             Teacher?     @relation(fields: [teacherId], references: [id], onDelete: Cascade)
  student             Student?     @relation(fields: [studentId], references: [id], onDelete: Cascade)
  guardian            Guardian?    @relation(fields: [guardianId], references: [id], onDelete: Cascade)
  baseUser            BaseUser?    @relation(fields: [baseUserId], references: [id], onDelete: Cascade)
}

// Base User Profile (minimal profile for basic users)
model BaseUser {
  id                  String       @id @default(uuid())
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  profile             Profile?
}

// Teacher Profile
model Teacher {
  id                  String       @id @default(uuid())
  biography           String?
  experienceYears     Int?
  specialization      String?
  profileViews        Int          @default(0)
  rating              Float        @default(0)
  studentsCount       Int?
  centersCount        Int?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  profile             Profile?
  classSessions       ClassSession[]
  groups              Group[]      @relation("GroupTeachers")
  subjects            Subject[]    @relation("SubjectTeachers")
}

// Student Profile
model Student {
  id                     String       @id @default(uuid())
  grade                  StudentGrade
  level                  String?
  performanceScore       Float?
  totalSessionsAttended  Int          @default(0)
  totalPayments          Float        @default(0)
  notes                  String?
  createdAt              DateTime     @default(now())
  updatedAt              DateTime     @updatedAt
  
  // Relations
  profile                Profile?
  groups                 Group[]      @relation("StudentGroups")
  attendance             Attendance[]
  gradeLevel             GradeLevel?  @relation(fields: [gradeLevelId], references: [id])
  gradeLevelId           String?
}

// Guardian Profile
model Guardian {
  id                  String       @id @default(uuid())
  emergencyContact    String?
  relationship        String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Relations
  profile             Profile?
}

model Center {
  id          String   @id @default(cuid())
  name        String
  location    String?
  description String?
  ownerId     String
  owner       User     @relation("UserCentersOwned", fields: [ownerId], references: [id])
  users       UserOnCenter[]
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime? // for soft delete
  gradeLevels GradeLevel[]
  groups      Group[]
  subjects    Subject[]
  classSessions ClassSession[]
}

model Role {
  id              String           @id @default(uuid())
  name            String           @unique
  isAdmin         Boolean          @default(false)
  metadata        Json?
  permissions     Json?            // Array of permission objects
  userRoles       UserRole[]
  // Add missing relations for legacy models
  users           UserOnCenter[]
  scope           RoleScope // 'GLOBAL' | 'CENTER'
  centerId        String?   // only set if scope = 'CENTER'
}

model Permission {
  id              String           @id @default(uuid())
  name            String           // Human-readable name
  action          String           @unique
  isAdmin         Boolean          @default(false)
  userPermissions UserPermission[]
}

model UserOnCenter {
  id        String   @id @default(cuid())
  userId    String
  centerId  String
  roleId    String
  createdBy String
  isActive  Boolean  @default(true) // Center-specific activation status
  metadata  Json?
  user      User     @relation(fields: [userId], references: [id])
  center    Center   @relation(fields: [centerId], references: [id])
  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model RefreshToken {
  id        String   @id @default(uuid())
  token     String   @unique
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  expiresAt DateTime
  createdAt DateTime @default(now())
}

model EmailVerification {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
}

model PasswordResetToken {
  id        String   @id @default(uuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  // Relations
  user      User     @relation(fields: [userId], references: [id])
}

model UserRole {
  id        String   @id @default(uuid())
  userId    String
  roleId    String
  scopeType RoleScope  // 'CENTER' | 'GLOBAL'
  scopeId   String?     // centerId if CENTER, null if GLOBAL
  user      User     @relation(fields: [userId], references: [id])
  role      Role     @relation(fields: [roleId], references: [id])
  createdAt DateTime @default(now())

  @@unique([userId, roleId, scopeType, scopeId])
}

model UserPermission {
  id            String   @id @default(uuid())
  userId        String
  permissionId  String
  scopeType     RoleScope  // 'CENTER' | 'GLOBAL'
  scopeId       String?     // centerId if CENTER, null if GLOBAL
  user          User     @relation(fields: [userId], references: [id])
  permission    Permission @relation(fields: [permissionId], references: [id])
  createdAt     DateTime @default(now())

  @@unique([userId, permissionId, scopeType, scopeId])
}

model GradeLevel {
  id          String   @id @default(cuid())
  name        String
  description String?
  level       Int?
  centerId    String?
  center      Center?  @relation(fields: [centerId], references: [id])
  groups      Group[]
  subjects    Subject[]
  students    Student[] // Students with STUDENT profile type
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Group {
  id          String   @id @default(cuid())
  name        String
  description String?
  centerId    String
  center      Center   @relation(fields: [centerId], references: [id])
  gradeLevel  GradeLevel? @relation(fields: [gradeLevelId], references: [id])
  gradeLevelId String?
  maxStudents Int?
  isActive    Boolean  @default(true)
  teachers    Teacher[] @relation("GroupTeachers")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  students    Student[] @relation("StudentGroups")
  classSessions  ClassSession[]
}

model Subject {
  id          String   @id @default(cuid())
  name        String
  description String?
  centerId    String
  center      Center   @relation(fields: [centerId], references: [id])
  gradeLevel  GradeLevel? @relation(fields: [gradeLevelId], references: [id])
  gradeLevelId String?
  credits     Int?
  duration    Int? // in minutes
  isActive    Boolean  @default(true)
  teachers    Teacher[] @relation("SubjectTeachers")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  classSessions ClassSession[]
}

model ClassSession {
  id             String   @id @default(uuid())
  title          String
  description    String?
  teacherId      String
  centerId       String?
  groupId        String?
  subjectId      String?
  grade          String?
  startTime      DateTime
  endTime        DateTime
  recurrenceRule String?
  isCancelled    Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  teacher   Teacher   @relation(fields: [teacherId], references: [id])
  center    Center?   @relation(fields: [centerId], references: [id])
  group     Group?    @relation(fields: [groupId], references: [id])
  subject   Subject?  @relation(fields: [subjectId], references: [id])
  attendances Attendance[]

  @@index([teacherId])
  @@index([centerId])
  @@index([groupId])
  @@index([subjectId])
  @@index([startTime])
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  LATE
  EXCUSED
}

model Attendance {
  id         String           @id @default(uuid())
  sessionId  String
  studentId  String
  status     AttendanceStatus
  note       String?         @db.VarChar(255)
  markedById String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  // Relations
  session    ClassSession @relation(fields: [sessionId], references: [id])
  student    Student      @relation(fields: [studentId], references: [id])
}

model UserAccess {
  id           String   @id @default(uuid())
  userId       String   // User granting access
  targetUserId String   // User receiving access
  createdAt    DateTime @default(now())

  // Relations
  granter      User     @relation("AccessGranter", fields: [userId], references: [id])
  target       User     @relation("AccessTarget", fields: [targetUserId], references: [id])

  @@unique([userId, targetUserId])
}
